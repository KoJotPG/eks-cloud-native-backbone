---
# Authenticate with AWS EKS and update local kubeconfig
- name: "Update kubeconfig for the EKS cluster"
  # This command retrieves the cluster endpoint and certificate authority data
  # It merges these details into ~/.kube/config for use by kubectl and Ansible modules
  ansible.builtin.shell: "aws eks update-kubeconfig --name {{ cluster_name }} --region {{ region }}"
  register: kubeconfig_status
  changed_when: "'Updated context' in kubeconfig_status.stdout"

# Basic health check to ensure API connectivity
- name: "Verify cluster connectivity"
  # Runs a simple 'kubectl get nodes' to confirm the API is reachable and authenticated
  kubernetes.core.k8s_info:
    kind: Node
  register: node_list
  failed_when: node_list.resources | length == 0